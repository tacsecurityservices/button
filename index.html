<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SecureLink Dispatch - Control Center</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); color: #fff; height: 100vh; overflow: hidden; }

        /* ‚îÄ‚îÄ Login ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
        .login-container { height: 100vh; display: flex; align-items: center; justify-content: center; padding: 24px; overflow-y: auto; }
        .login-box { width: 100%; max-width: 440px; padding: 20px 0; }
        .login-header { text-align: center; margin-bottom: 28px; }
        .logo-box { width: 72px; height: 72px; background: linear-gradient(135deg, #3b82f6 0%, #06b6d4 100%); border-radius: 16px; display: flex; align-items: center; justify-content: center; margin: 0 auto 16px; font-size: 36px; box-shadow: 0 10px 20px rgba(59,130,246,0.3); }
        .login-title    { font-size: 24px; font-weight: 900; margin-bottom: 4px; }
        .login-subtitle { color: #94a3b8; font-size: 11px; }
        .login-form { display: flex; flex-direction: column; gap: 10px; margin-bottom: 16px; }
        .iw { background-color: #1e293b; border: 1px solid #334155; border-radius: 10px; padding: 10px 12px; display: flex; flex-direction: column; transition: border-color 0.2s; }
        .iw:focus-within { border-color: #3b82f6; }
        .il { font-size: 9px; color: #64748b; text-transform: uppercase; font-weight: bold; margin-bottom: 3px; }
        .iw input { background: transparent; border: none; outline: none; color: #fff; font-size: 13px; }
        .iw input::placeholder { color: #64748b; }
        .section-lbl { font-size: 10px; font-weight: bold; text-transform: uppercase; color: #a855f7; padding-top: 10px; margin-top: 4px; border-top: 1px solid #334155; display: flex; align-items: center; gap: 8px; }
        .section-lbl::after { content:''; flex:1; height:1px; background:#1e293b; }
        .btn-login { padding: 13px; background: linear-gradient(135deg, #3b82f6 0%, #06b6d4 100%); color: white; font-weight: bold; border: none; border-radius: 10px; cursor: pointer; transition: all 0.3s; font-size: 13px; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-login:hover { transform: translateY(-2px); box-shadow: 0 10px 20px rgba(59,130,246,0.3); }
        .info-panel { background-color: rgba(59,130,246,0.08); border: 1px solid rgba(59,130,246,0.2); padding: 14px; border-radius: 10px; margin-top: 12px; font-size: 11px; color: #cbd5e1; line-height: 1.7; }
        .info-panel b { color: #93c5fd; }
        .orange-panel { background-color: rgba(249,115,22,0.08); border: 1px solid rgba(249,115,22,0.2); padding: 12px; border-radius: 10px; margin-top: 8px; font-size: 11px; color: #fdba74; }
        .orange-panel a { color: #fb923c; font-weight: bold; }

        /* ‚îÄ‚îÄ Dashboard ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
        .dashboard      { display: none; height: 100vh; flex-direction: column; }
        .dashboard.show { display: flex; }
        .dash-hdr { background: linear-gradient(to right, #1e293b, #0f172a); border-bottom: 1px solid #334155; padding: 12px 20px; display: flex; align-items: center; justify-content: space-between; flex-shrink: 0; }
        .dash-left { display: flex; align-items: center; gap: 10px; }
        .dash-logo { width: 38px; height: 38px; background: linear-gradient(135deg, #3b82f6 0%, #06b6d4 100%); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 19px; }
        .dash-title { font-size: 16px; font-weight: 900; }
        .dash-sub   { font-size: 10px; color: #64748b; }
        .dash-right { display: flex; align-items: center; gap: 8px; }
        .live-badge { display: flex; align-items: center; gap: 5px; background-color: rgba(34,197,94,0.1); border: 1px solid rgba(34,197,94,0.3); border-radius: 20px; padding: 4px 10px; font-size: 10px; font-weight: bold; color: #86efac; }
        .live-badge.offline { background-color: rgba(239,68,68,0.1); border-color: rgba(239,68,68,0.3); color: #fca5a5; }
        .live-dot     { width: 7px; height: 7px; border-radius: 50%; background-color: #22c55e; animation: blink 1s ease-in-out infinite; }
        .live-dot.off { background-color: #ef4444; animation: none; }
        .hdr-btn { padding: 6px 12px; background-color: #1e293b; color: #cbd5e1; border: 1px solid #334155; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 11px; transition: all 0.2s; }
        .hdr-btn:hover { background-color: #334155; }
        .hdr-btn.logout:hover   { background-color: #dc2626; border-color: #dc2626; }
        .hdr-btn.settings:hover { border-color: #a855f7; color: #c084fc; }
        @keyframes blink { 0%,100%{opacity:1;} 50%{opacity:0.3;} }

        /* Stats bar */
        .stats-bar { background-color: rgba(30,41,59,0.5); border-bottom: 1px solid #334155; padding: 10px 20px; display: flex; gap: 28px; align-items: center; flex-shrink: 0; }
        .stat-item { display: flex; align-items: center; gap: 8px; }
        .stat-dot  { width: 11px; height: 11px; border-radius: 50%; animation: blink 2s ease-in-out infinite; }
        .stat-dot.active   { background-color: #ef4444; }
        .stat-dot.resolved { background-color: #22c55e; }
        .stat-dot.calls    { background-color: #a855f7; }
        .stat-label { font-size: 9px; color: #64748b; text-transform: uppercase; font-weight: bold; }
        .stat-value { font-size: 19px; font-weight: 900; }

        /* Grid */
        .main-grid { display: grid; grid-template-columns: 270px 1fr 250px; flex: 1; overflow: hidden; }

        /* Left panel */
        .alerts-panel { border-right: 1px solid #334155; padding: 14px; overflow-y: auto; display: flex; flex-direction: column; background-color: rgba(15,23,42,0.5); }
        .filter-row { display: flex; gap: 4px; margin-bottom: 14px; }
        .filter-btn { padding: 5px 9px; background-color: #1e293b; color: #cbd5e1; border: 1px solid #334155; border-radius: 7px; cursor: pointer; font-weight: bold; font-size: 10px; transition: all 0.2s; }
        .filter-btn.on { background-color: #3b82f6; border-color: #3b82f6; color: white; }
        .alerts-list { flex: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 7px; }
        .alert-card { background-color: #1e293b; border: 2px solid #334155; border-radius: 12px; padding: 11px; cursor: pointer; transition: all 0.2s; }
        .alert-card:hover { background-color: #334155; border-color: #475569; }
        .alert-card.sel   { background-color: #1e3a5f; border-color: #3b82f6; }
        .alert-card.new-in { animation: newFlash 0.8s ease-out; }
        @keyframes newFlash { 0%{border-color:#ef4444;box-shadow:0 0 20px rgba(239,68,68,0.6);}100%{border-color:#334155;box-shadow:none;} }
        .card-row   { display: flex; align-items: center; gap: 6px; margin-bottom: 3px; }
        .card-plate { font-weight: 900; font-size: 13px; letter-spacing: 1px; }
        .card-desc  { font-size: 9px; color: #cbd5e1; background-color: rgba(15,23,42,0.8); padding: 1px 5px; border-radius: 4px; }
        .card-driver{ font-size: 11px; color: #94a3b8; margin: 2px 0; }
        .card-loc   { font-size: 10px; color: #64748b; }
        .card-meta  { font-size: 9px; color: #475569; margin-top: 3px; display: flex; gap: 6px; align-items: center; flex-wrap: wrap; }
        .call-pill  { font-size: 9px; font-weight: bold; padding: 1px 6px; border-radius: 10px; }
        .call-pill.idle     { background-color: rgba(100,116,139,0.2); color: #64748b; }
        .call-pill.calling  { background-color: rgba(168,85,247,0.2); color: #c084fc; animation: blink 1s infinite; }
        .call-pill.answered { background-color: rgba(34,197,94,0.2); color: #86efac; }
        .call-pill.failed   { background-color: rgba(239,68,68,0.2); color: #fca5a5; }
        .call-pill.done     { background-color: rgba(59,130,246,0.2); color: #93c5fd; }
        .no-alerts { display: flex; align-items: center; justify-content: center; height: 100%; flex-direction: column; text-align: center; color: #64748b; gap: 8px; }

        /* Centre panel */
        .details-panel { border-right: 1px solid #334155; padding: 14px; overflow-y: auto; background-color: rgba(15,23,42,0.3); display: flex; flex-direction: column; }
        .empty-det { display: flex; align-items: center; justify-content: center; height: 100%; text-align: center; color: #64748b; flex-direction: column; gap: 10px; }
        #detContent { flex-direction: column; flex: 1; }
        .det-tabs { display: flex; gap: 4px; margin-bottom: 12px; border-bottom: 1px solid #334155; }
        .det-tab  { padding: 6px 12px; background: none; border: none; color: #64748b; cursor: pointer; font-size: 11px; font-weight: bold; border-bottom: 2px solid transparent; transition: all 0.2s; white-space: nowrap; }
        .det-tab.on { color: #3b82f6; border-bottom-color: #3b82f6; }
        .det-tab.retell-tab.on { color: #a855f7; border-bottom-color: #a855f7; }
        .tab-pane    { display: none; }
        .tab-pane.on { display: block; }
        .live-chip { display: inline-flex; align-items: center; gap: 5px; background-color: rgba(34,197,94,0.1); border: 1px solid rgba(34,197,94,0.3); border-radius: 20px; padding: 3px 8px; font-size: 9px; color: #86efac; margin-bottom: 8px; }
        .live-chip span { width: 5px; height: 5px; border-radius: 50%; background: #22c55e; animation: blink 1s infinite; display: inline-block; }
        .ov-card { background-color: #1e293b; border: 1px solid #334155; border-radius: 10px; padding: 11px; margin-bottom: 9px; }
        .ov-title { font-size: 9px; color: #64748b; text-transform: uppercase; font-weight: bold; margin-bottom: 7px; }
        .ov-body  { font-size: 12px; color: #cbd5e1; line-height: 1.85; }
        .ov-body strong { color: #e2e8f0; }

        /* ‚ïê‚ïê‚ïê RETELL PANEL ‚ïê‚ïê‚ïê */
        .retell-panel { background: linear-gradient(135deg, rgba(88,28,135,0.15) 0%, rgba(30,41,59,0.8) 100%); border: 1px solid rgba(168,85,247,0.3); border-radius: 12px; padding: 14px; margin-bottom: 12px; }
        .retell-hdr   { display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px; }
        .retell-title { font-size: 12px; font-weight: 900; color: #c084fc; display: flex; align-items: center; gap: 6px; }
        .auto-row     { display: flex; align-items: center; gap: 7px; font-size: 10px; color: #94a3b8; }
        .toggle { width: 34px; height: 18px; background-color: #334155; border-radius: 9px; position: relative; cursor: pointer; transition: background 0.3s; flex-shrink: 0; }
        .toggle.on { background-color: #a855f7; }
        .toggle::after { content:''; width:12px; height:12px; background:white; border-radius:50%; position:absolute; top:3px; left:3px; transition:transform 0.3s; }
        .toggle.on::after { transform: translateX(16px); }
        .services-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 7px; margin-bottom: 10px; }
        .svc-btn { padding: 9px 6px; border-radius: 10px; border: 1px solid rgba(168,85,247,0.3); background: rgba(88,28,135,0.2); cursor: pointer; transition: all 0.2s; display: flex; flex-direction: column; align-items: center; gap: 3px; text-align: center; }
        .svc-btn:hover:not(:disabled) { background: rgba(168,85,247,0.3); border-color: rgba(168,85,247,0.6); transform: translateY(-1px); }
        .svc-btn:disabled { opacity: 0.4; cursor: not-allowed; }
        .svc-btn.calling  { background: rgba(168,85,247,0.3); border-color: #a855f7; animation: blink 0.8s infinite; }
        .svc-btn.answered { background: rgba(34,197,94,0.2); border-color: #22c55e; animation: none; }
        .svc-btn.failed   { background: rgba(239,68,68,0.2); border-color: #ef4444; animation: none; }
        .svc-btn.done     { background: rgba(59,130,246,0.15); border-color: #3b82f6; animation: none; }
        .svc-icon   { font-size: 18px; }
        .svc-name   { font-size: 10px; font-weight: bold; color: #e2e8f0; }
        .svc-num    { font-size: 9px; color: #94a3b8; }
        .svc-status { font-size: 9px; color: #c084fc; min-height: 12px; }
        .wh-status  { display: flex; align-items: center; gap: 6px; font-size: 10px; padding: 6px 10px; border-radius: 8px; margin-top: 8px; }
        .wh-status.ok   { background-color: rgba(34,197,94,0.1); color: #86efac; }
        .wh-status.err  { background-color: rgba(239,68,68,0.1); color: #fca5a5; }
        .wh-status.warn { background-color: rgba(168,85,247,0.1); color: #c084fc; }
        .call-log-box { background-color: #0f172a; border: 1px solid #1e293b; border-radius: 8px; padding: 10px; max-height: 160px; overflow-y: auto; }
        .call-log-ttl { font-size: 9px; color: #64748b; text-transform: uppercase; font-weight: bold; margin-bottom: 6px; }
        .call-log-entry { font-size: 10px; padding: 5px 7px; border-radius: 4px; margin-bottom: 4px; border-left: 2px solid #a855f7; background-color: rgba(168,85,247,0.05); color: #cbd5e1; line-height: 1.4; }
        .call-log-ts    { color: #475569; font-size: 9px; }

        /* Notes */
        .notes-box { background-color: #1e293b; border: 1px solid #334155; border-radius: 8px; padding: 11px; margin-bottom: 10px; }
        .notes-ttl { font-size: 9px; font-weight: bold; text-transform: uppercase; margin-bottom: 7px; color: #3b82f6; }
        .notes-ta  { width: 100%; background-color: #0f172a; border: 1px solid #334155; border-radius: 6px; padding: 8px; color: #fff; font-family: Monaco, monospace; font-size: 11px; min-height: 60px; resize: vertical; transition: border-color 0.2s; }
        .notes-ta:focus { outline: none; border-color: #3b82f6; }
        .notes-ta::placeholder { color: #64748b; }
        .notes-log { margin-top: 8px; max-height: 120px; overflow-y: auto; }
        .note-entry { background-color: #0f172a; padding: 5px 7px 5px 9px; border-radius: 4px; margin-bottom: 4px; font-size: 10px; border-left: 2px solid #3b82f6; }
        .note-ts { color: #64748b; font-size: 9px; }
        .note-txt{ color: #cbd5e1; margin-top: 2px; }

        /* Action buttons */
        .act-btns { display: flex; flex-direction: column; gap: 6px; margin-top: 10px; flex-shrink: 0; }
        .act-btn  { padding: 10px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 11px; display: flex; align-items: center; justify-content: center; gap: 6px; transition: all 0.2s; }
        .btn-maps  { background: linear-gradient(135deg, #3b82f6 0%, #06b6d4 100%); color: white; }
        .btn-maps:hover  { transform: translateY(-1px); box-shadow: 0 5px 14px rgba(59,130,246,0.3); }
        .btn-res   { background-color: #16a34a; color: white; }
        .btn-res:hover   { background-color: #15803d; }
        .btn-copy  { background-color: #334155; color: #cbd5e1; }
        .btn-copy:hover  { background-color: #475569; }
        .btn-note  { background-color: #3b82f6; color: white; margin-top: 4px; }
        .btn-note:hover  { background-color: #2563eb; }

        /* Right analytics */
        .analytics-panel { padding: 14px; overflow-y: auto; background-color: rgba(15,23,42,0.5); display: flex; flex-direction: column; gap: 10px; }
        .metric-card { background-color: #1e293b; border: 1px solid #334155; border-radius: 10px; padding: 13px; }
        .metric-title { font-size: 9px; color: #64748b; text-transform: uppercase; font-weight: bold; margin-bottom: 7px; }
        .metric-val   { font-size: 26px; font-weight: 900; color: #3b82f6; margin-bottom: 3px; }
        .metric-val.purple { color: #a855f7; }
        .metric-unit  { font-size: 10px; color: #94a3b8; }

        /* Settings modal */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.75); backdrop-filter: blur(4px); z-index: 50; display: none; align-items: center; justify-content: center; padding: 20px; }
        .modal-overlay.show { display: flex; }
        .modal-box { background-color: #0f172a; border: 1px solid #334155; border-radius: 18px; padding: 22px; width: 100%; max-width: 460px; max-height: 85vh; overflow-y: auto; animation: fadeUp 0.25s ease-out; }
        @keyframes fadeUp { from{opacity:0;transform:translateY(16px);}to{opacity:1;transform:translateY(0);} }
        .modal-hdr { display: flex; justify-content: space-between; align-items: center; margin-bottom: 18px; }
        .modal-title { font-size: 17px; font-weight: 900; }
        .close-btn { background: none; border: none; color: #64748b; cursor: pointer; font-size: 22px; }
        .close-btn:hover { color: #fff; }
        .set-section { margin-bottom: 18px; }
        .set-title { font-size: 10px; font-weight: bold; text-transform: uppercase; color: #a855f7; margin-bottom: 8px; }
        .phone-row { display: flex; gap: 8px; align-items: center; margin-bottom: 7px; }
        .phone-lbl { font-size: 11px; color: #94a3b8; width: 78px; flex-shrink: 0; }
        .btn-save-settings { width: 100%; padding: 12px; background: linear-gradient(135deg, #a855f7 0%, #7c3aed 100%); color: white; font-weight: bold; border: none; border-radius: 10px; cursor: pointer; font-size: 13px; margin-top: 6px; transition: all 0.2s; }
        .btn-save-settings:hover { transform: translateY(-1px); box-shadow: 0 8px 16px rgba(168,85,247,0.3); }

        /* Scrollbars */
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 2px; }

        /* Toast */
        .toast { position: fixed; top: 14px; right: 14px; padding: 9px 16px; border-radius: 8px; font-weight: bold; z-index: 100; display: none; animation: toastIn 0.3s ease-out; font-size: 12px; max-width: 280px; }
        .toast.show    { display: block; }
        .toast.success { background-color: #16a34a; }
        .toast.error   { background-color: #dc2626; }
        .toast.alert   { background-color: #dc2626; }
        .toast.purple  { background-color: #7c3aed; }
        @keyframes toastIn { from{transform:translateX(110%);opacity:0;}to{transform:translateX(0);opacity:1;} }
        /* Phone display panel */
        .phone-display-row { display:flex; align-items:center; justify-content:space-between; padding:7px 10px; background-color:#0f172a; border-radius:8px; border:1px solid #1e293b; }
        .phone-display-icon { font-size:15px; }
        .phone-display-info { flex:1; margin-left:8px; }
        .phone-display-name { font-size:10px; font-weight:bold; color:#e2e8f0; }
        .phone-display-num  { font-size:11px; color:#a855f7; font-family:monospace; margin-top:1px; }
        .phone-display-num.empty { color:#334155; font-style:italic; }
        .phone-display-call { background:none; border:1px solid #334155; border-radius:6px; color:#94a3b8; cursor:pointer; font-size:10px; padding:3px 8px; transition:all 0.2s; white-space:nowrap; }
        .phone-display-call:hover:not(:disabled) { border-color:#a855f7; color:#c084fc; }
        .phone-display-call:disabled { opacity:0.3; cursor:not-allowed; }

        /* User phone badge on alert card */
        .card-phone { font-size:10px; color:#a855f7; font-family:monospace; margin-top:2px; }

        audio { display: none; }
    </style>
</head>
<body>

<!-- ‚ïê‚ïê LOGIN ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="loginContainer" class="login-container">
    <div class="login-box">
        <div class="login-header">
            <div class="logo-box">üì°</div>
            <h1 class="login-title">SecureLink Dispatch</h1>
            <p class="login-subtitle">Control Center + Retell AI Response Agent</p>
        </div>

        <form class="login-form" onsubmit="dc.handleLogin(event)">
            <div class="iw">
                <label class="il">Dispatcher Name</label>
                <input type="text" id="dispName" placeholder="Officer Rodriguez" required>
            </div>

            <div class="section-lbl">ü§ñ Make.com + Retell Setup</div>

            <div class="iw">
                <label class="il">Make.com Webhook URL</label>
                <input type="url" id="webhookUrl" placeholder="https://hook.eu1.make.com/‚Ä¶" value="https://hook.eu1.make.com/phdt5uufktqhv7w2cxn2auwps964wkvv">
            </div>
            <div class="iw">
                <label class="il">üöî SAPS Number</label>
                <input type="tel" id="sapsNum" placeholder="+27 10 111 0000">
            </div>
            <div class="iw">
                <label class="il">üõ°Ô∏è Armed Response Number</label>
                <input type="tel" id="armedNum" placeholder="+27 XX XXX XXXX">
            </div>
            <div class="iw">
                <label class="il">üöë Medical / Ambulance Number</label>
                <input type="tel" id="medNum" placeholder="+27 10 205 3000">
            </div>
            <div class="iw">
                <label class="il">üë®‚Äçüë©‚Äçüëß Family / Emergency Contact</label>
                <input type="tel" id="familyNum" placeholder="+27 XX XXX XXXX">
            </div>

            <button type="submit" class="btn-login">üì° ACCESS DISPATCH CENTER</button>
        </form>

        <div class="info-panel">
            <b>How the Retell AI agent works:</b><br>
            PANIC fires ‚Üí dispatch receives the alert ‚Üí you click a service button ‚Üí
            Make.com webhook triggers ‚Üí Retell calls the number and reads the full brief
            (driver, vehicle, GPS, Maps link) to the operator. No manual calls needed.
        </div>
        <div class="orange-panel">
            üì± User app: <a href="https://tacsecurityservices.github.io/buttot/" target="_blank">tacsecurityservices.github.io/buttot</a>
        </div>
    </div>
</div>

<!-- ‚ïê‚ïê DASHBOARD ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="dashboard" class="dashboard">

    <div class="dash-hdr">
        <div class="dash-left">
            <div class="dash-logo">üì°</div>
            <div>
                <div class="dash-title">SecureLink Dispatch</div>
                <div class="dash-sub">Control Center ‚Ä¢ <span id="dispTitle">Officer</span></div>
            </div>
        </div>
        <div class="dash-right">
            <div class="live-badge" id="liveBadge">
                <div class="live-dot" id="liveDot"></div>
                <span id="liveTxt">Connecting‚Ä¶</span>
            </div>
            <button class="hdr-btn settings" onclick="dc.showSettings()">‚öôÔ∏è Settings</button>
            <button class="hdr-btn logout"   onclick="dc.logout()">üö™ Logout</button>
        </div>
    </div>

    <div class="stats-bar">
        <div class="stat-item"><div class="stat-dot active"></div><div><div class="stat-label">Active</div><div class="stat-value" id="activeCount">0</div></div></div>
        <div class="stat-item"><div class="stat-dot resolved"></div><div><div class="stat-label">Resolved</div><div class="stat-value" id="resolvedCount">0</div></div></div>
        <div class="stat-item"><div class="stat-dot calls"></div><div><div class="stat-label">AI Calls</div><div class="stat-value" id="callCount">0</div></div></div>
        <div class="stat-item"><div><div class="stat-label">Last Update</div><div class="stat-value" id="lastUpdate" style="font-size:13px;">‚Äî</div></div></div>
    </div>

    <div class="main-grid">

        <!-- Left: Alerts -->
        <div class="alerts-panel">
            <div class="filter-row">
                <button class="filter-btn on" onclick="dc.setFilter('active',   event)">üî¥ Active</button>
                <button class="filter-btn"    onclick="dc.setFilter('resolved', event)">‚úÖ Done</button>
                <button class="filter-btn"    onclick="dc.setFilter('all',      event)">üìã All</button>
            </div>
            <div class="alerts-list" id="alertsList">
                <div class="no-alerts">
                    <div style="font-size:30px;">üì°</div>
                    <div>Listening for alerts‚Ä¶</div>
                    <div style="font-size:10px;color:#334155;margin-top:4px;">PANIC presses appear instantly</div>
                </div>
            </div>
        </div>

        <!-- Centre: Details -->
        <div class="details-panel">
            <div class="empty-det" id="emptyDet">
                <div style="font-size:30px;">üìã</div>
                <div>Select an alert</div>
                <div style="font-size:11px;color:#475569;">Then use the ü§ñ Retell tab to dispatch AI calls</div>
            </div>

            <div id="detContent" style="display:none;">
                <div class="det-tabs">
                    <button class="det-tab on"         onclick="dc.switchTab('overview', event)">üìã Overview</button>
                    <button class="det-tab retell-tab" onclick="dc.switchTab('retell',   event)">ü§ñ Retell Agent</button>
                    <button class="det-tab"            onclick="dc.switchTab('notes',    event)">üìù Log</button>
                </div>

                <div id="tab-overview" class="tab-pane on"></div>

                <div id="tab-retell" class="tab-pane">
                    <div class="retell-panel">
                        <div class="retell-hdr">
                            <div class="retell-title">ü§ñ Retell AI Response Agent</div>
                            <div style="font-size:9px;background:rgba(34,197,94,0.15);border:1px solid rgba(34,197,94,0.3);color:#86efac;padding:3px 9px;border-radius:10px;font-weight:bold;">
                                ‚ö° AUTO ‚Äî fires on every PANIC
                            </div>
                        </div>
                        <div style="font-size:10px;color:#94a3b8;margin-bottom:10px;line-height:1.6;">
                            Calls fire <strong style="color:#c084fc;">automatically</strong> the moment a user presses PANIC ‚Äî
                            no dispatcher action needed. Use the buttons below only to re-call a service manually if needed.
                        </div>
                        <div class="services-grid" id="servicesGrid"></div>
                        <div class="wh-status" id="whStatus" style="display:none;"></div>
                    </div>
                    <div class="call-log-box">
                        <div class="call-log-ttl">üìû Call Log</div>
                        <div id="callLog"><div style="font-size:10px;color:#334155;">No calls yet for this alert</div></div>
                    </div>
                </div>

                <div id="tab-notes" class="tab-pane">
                    <div class="notes-box">
                        <div class="notes-ttl">üìù Dispatch Notes</div>
                        <textarea class="notes-ta" id="noteInput" placeholder="'SAPS notified', 'Unit en route'‚Ä¶"></textarea>
                        <button class="act-btn btn-note" onclick="dc.saveNote()" style="margin-top:8px;">üíæ Save Note</button>
                        <div class="notes-log" id="notesLog"></div>
                    </div>
                </div>

                <div class="act-btns">
                    <button class="act-btn btn-maps" onclick="dc.openMaps()">üó∫Ô∏è View on Maps</button>
                    <button class="act-btn btn-res"  id="resolveBtn" onclick="dc.resolveAlert()" style="display:none;">‚úÖ Resolve Alert</button>
                    <button class="act-btn btn-copy" onclick="dc.copyDetails()">üìã Copy Details</button>
                </div>
            </div>
        </div>

        <!-- Right: Analytics -->
        <div class="analytics-panel">
            <h3 style="font-size:13px;font-weight:900;">üìä Analytics</h3>
            <div class="metric-card"><div class="metric-title">Total Incidents</div><div class="metric-val" id="totalInc">0</div><div class="metric-unit">this session</div></div>
            <div class="metric-card"><div class="metric-title">Resolution Rate</div><div class="metric-val" id="resRate">‚Äî</div><div class="metric-unit">alerts resolved</div></div>
            <div class="metric-card"><div class="metric-title">AI Calls Dispatched</div><div class="metric-val purple" id="totalCalls">0</div><div class="metric-unit">via Retell agent</div></div>
            <div class="metric-card"><div class="metric-title">Avg Response Time</div><div class="metric-val" id="avgTime" style="font-size:16px;">‚Äî</div><div class="metric-unit">alert-to-resolve</div></div>

            <!-- Live service numbers card ‚Äî updated whenever settings are saved -->
            <div class="metric-card" style="border-color:rgba(168,85,247,0.3);">
                <div class="metric-title" style="color:#a855f7;">üìû Service Numbers</div>
                <div id="phoneDisplayPanel" style="display:flex;flex-direction:column;gap:7px;margin-top:2px;">
                    <!-- Populated by updatePhoneDisplay() -->
                </div>
                <button onclick="dc.showSettings()" style="margin-top:10px;width:100%;padding:7px;background:rgba(168,85,247,0.15);border:1px solid rgba(168,85,247,0.3);color:#c084fc;border-radius:7px;cursor:pointer;font-size:10px;font-weight:bold;">
                    ‚öôÔ∏è Edit Numbers
                </button>
            </div>

            <div class="metric-card" style="border-color:rgba(249,115,22,0.3);">
                <div class="metric-title" style="color:#f97316;">üîó User App</div>
                <div style="font-size:10px;color:#94a3b8;line-height:1.8;">
                    <a href="https://tacsecurityservices.github.io/buttot/" target="_blank" style="color:#f97316;font-weight:bold;">tacsecurityservices.github.io/buttot ‚Üó</a><br>
                    Share with users ‚Äî works on any device via Firebase.
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ‚ïê‚ïê SETTINGS MODAL ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="modal-overlay" id="settingsModal">
    <div class="modal-box">
        <div class="modal-hdr">
            <h3 class="modal-title">‚öôÔ∏è Settings</h3>
            <button class="close-btn" onclick="dc.hideSettings()">√ó</button>
        </div>

        <div class="set-section">
            <div class="set-title">ü§ñ Make.com Webhook</div>
            <div class="iw"><label class="il">Webhook URL</label><input type="url" id="settingsWebhook" placeholder="https://hook.eu1.make.com/‚Ä¶" value="https://hook.eu1.make.com/phdt5uufktqhv7w2cxn2auwps964wkvv"></div>
            <div style="font-size:10px;color:#64748b;margin-top:6px;line-height:1.6;">
                In Make.com: create a new scenario ‚Üí add a <b>Webhooks</b> trigger ‚Üí copy the URL here.
                Then add an <b>HTTP</b> module that POSTs to <code style="color:#818cf8;">https://api.retellai.com/v2/create-phone-call</code>
                with your Retell API key in the Authorization header.
            </div>
        </div>

        <div class="set-section">
            <div class="set-title">üìû Support Numbers</div>
            <div class="phone-row"><span class="phone-lbl">üöî SAPS</span><div class="iw" style="flex:1;"><input type="tel" id="settingsSaps" placeholder="+27 10 111 0000"></div></div>
            <div class="phone-row"><span class="phone-lbl">üõ°Ô∏è Armed</span><div class="iw" style="flex:1;"><input type="tel" id="settingsArmed" placeholder="+27 XX XXX XXXX"></div></div>
            <div class="phone-row"><span class="phone-lbl">üöë Medical</span><div class="iw" style="flex:1;"><input type="tel" id="settingsMed" placeholder="+27 10 205 3000"></div></div>
            <div class="phone-row"><span class="phone-lbl">üë®‚Äçüë©‚Äçüëß Family</span><div class="iw" style="flex:1;"><input type="tel" id="settingsFamily" placeholder="+27 XX XXX XXXX"></div></div>
        </div>

        <div class="set-section">
            <div class="set-title">üîÑ Auto-Call on New Alert</div>
            <div style="display:flex;align-items:center;gap:12px;font-size:12px;color:#94a3b8;">
                <div class="toggle" id="settingsAutoToggle" onclick="this.classList.toggle('on')"></div>
                <div>Automatically call <b style="color:#e2e8f0;">Armed Response</b> when a new PANIC arrives</div>
            </div>
        </div>

        <button class="btn-save-settings" onclick="dc.saveSettings()">üíæ Save Settings</button>
    </div>
</div>

<div class="toast" id="toast"></div>
<audio id="alertSnd" src="data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBT+P1fLIeDEGIXfH8N2RQgsc"></audio>

<script type="module">
import { initializeApp }                     from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
import { getDatabase, ref, onValue, update } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-database.js";

const firebaseConfig = {
    apiKey:            "AIzaSyAAHkSygnrYJF4axl2Mc-1wsE7erkI5tSc",
    authDomain:        "punic-button-4428e.firebaseapp.com",
    databaseURL:       "https://punic-button-4428e-default-rtdb.europe-west1.firebasedatabase.app",
    projectId:         "punic-button-4428e",
    storageBucket:     "punic-button-4428e.firebasestorage.app",
    messagingSenderId: "838411218299",
    appId:             "1:838411218299:web:402c4d5c0385946b3ca1de",
    measurementId:     "G-LZY15XKQL5"
};

const firebase = initializeApp(firebaseConfig);
const db       = getDatabase(firebase);

const dc = window.dc = {
    dispatcherName: '',
    isLoggedIn:     false,
    allAlerts:      {},
    selectedId:     null,
    filterStatus:   'active',
    notes:          {},
    callLogs:       {},
    knownIds:       new Set(),
    totalCallsMade: 0,

    cfg: { webhookUrl:'https://hook.eu1.make.com/phdt5uufktqhv7w2cxn2auwps964wkvv', sapsNum:'', armedNum:'', medNum:'', familyNum:'', autoCall: false },

    // ‚îÄ‚îÄ Login ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    handleLogin(e) {
        e.preventDefault();
        const name = document.getElementById('dispName').value.trim();
        if (!name) { this.toast('‚ùå Enter your name', 'error'); return; }
        this.dispatcherName = name;
        this.isLoggedIn     = true;
        this.cfg.webhookUrl = document.getElementById('webhookUrl').value.trim();
        this.cfg.sapsNum    = document.getElementById('sapsNum').value.trim();
        this.cfg.armedNum   = document.getElementById('armedNum').value.trim();
        this.cfg.medNum     = document.getElementById('medNum').value.trim();
        this.cfg.familyNum  = document.getElementById('familyNum').value.trim();
        this.saveConfig();
        document.getElementById('loginContainer').style.display = 'none';
        document.getElementById('dashboard').classList.add('show');
        document.getElementById('dispTitle').textContent = name;
        this.toast(`üëã Welcome, ${name}!`, 'success');
        this.updatePhoneDisplay();
        this.startListening();
    },

    logout() {
        this.isLoggedIn = false;
        document.getElementById('loginContainer').style.display = 'flex';
        document.getElementById('dashboard').classList.remove('show');
        document.getElementById('dispName').value = '';
    },

    // ‚îÄ‚îÄ Config ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    saveConfig() { localStorage.setItem('sl-dcfg', JSON.stringify(this.cfg)); },
    loadConfig() {
        const raw = localStorage.getItem('sl-dcfg');
        if (!raw) {
            // First load ‚Äî pre-fill the login form with known webhook
            document.getElementById('webhookUrl').value = this.cfg.webhookUrl;
            return;
        }
        this.cfg = { ...this.cfg, ...JSON.parse(raw) };
        // Always keep webhook if saved config somehow lost it
        if (!this.cfg.webhookUrl) this.cfg.webhookUrl = 'https://hook.eu1.make.com/phdt5uufktqhv7w2cxn2auwps964wkvv';
        document.getElementById('webhookUrl').value = this.cfg.webhookUrl;
        document.getElementById('sapsNum').value    = this.cfg.sapsNum    || '';
        document.getElementById('armedNum').value   = this.cfg.armedNum   || '';
        document.getElementById('medNum').value     = this.cfg.medNum     || '';
        document.getElementById('familyNum').value  = this.cfg.familyNum  || '';
    },

    // ‚îÄ‚îÄ Toast ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    toast(msg, type = 'info') {
        const el = document.getElementById('toast');
        el.textContent = msg;
        el.className = `toast show ${type}`;
        setTimeout(() => el.classList.remove('show'), 4000);
    },

    // ‚îÄ‚îÄ Firebase ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    startListening() {
        onValue(ref(db, '.info/connected'), snap => {
            const on = snap.val();
            document.getElementById('liveDot').className   = 'live-dot' + (on ? '' : ' off');
            document.getElementById('liveTxt').textContent = on ? 'FIREBASE LIVE' : 'OFFLINE';
            document.getElementById('liveBadge').className = 'live-badge' + (on ? '' : ' offline');
        });

        onValue(ref(db, 'alerts'), snap => {
            const raw = snap.val() || {};

            // Detect new alerts ‚Äî just notify dispatcher, calls already fired from user app
            Object.values(raw).forEach(a => {
                if (a.status === 'active' && !this.knownIds.has(a.alertId)) {
                    this.knownIds.add(a.alertId);
                    if (this.isLoggedIn) {
                        document.getElementById('alertSnd').play().catch(() => {});
                        this.toast(`üö® ${a.userName} ${a.userSurname} ‚Äî ${a.vehicleReg} ‚Ä¢ AI calling services‚Ä¶`, 'alert');
                        setTimeout(() => {
                            const el = document.querySelector(`[data-id="${a.alertId}"]`);
                            if (el) { el.classList.add('new-in'); setTimeout(() => el.classList.remove('new-in'), 900); }
                        }, 120);
                    }
                }
            });

            // Refresh live location line
            if (this.selectedId && raw[this.selectedId]) {
                const a = raw[this.selectedId];
                const el = document.getElementById('det-live-loc');
                if (el) el.textContent = `${a.location?.lat?.toFixed(6) ?? '--'}, ${a.location?.lng?.toFixed(6) ?? '--'} (¬±${a.location?.accuracy ?? '--'}m)`;
                document.getElementById('resolveBtn').style.display = a.status === 'active' ? 'flex' : 'none';
            }

            this.allAlerts = raw;
            this.render();
            this.updateStats();
            this.updatePhoneDisplay();
            document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
        });
    },

    // ‚îÄ‚îÄ Filter ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    setFilter(status, e) {
        this.filterStatus = status;
        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('on'));
        if (e?.target) e.target.classList.add('on');
        this.render();
    },

    // ‚îÄ‚îÄ Render list ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    render() {
        const list = document.getElementById('alertsList');
        const alerts = Object.values(this.allAlerts)
            .filter(a => this.filterStatus === 'all' ? true : a.status === this.filterStatus)
            .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

        if (!alerts.length) {
            list.innerHTML = `<div class="no-alerts"><div style="font-size:30px;">üì°</div><div>No ${this.filterStatus === 'all' ? '' : this.filterStatus} alerts</div></div>`;
            return;
        }

        list.innerHTML = alerts.map(a => {
            const logs    = this.callLogs[a.alertId] || [];
            const last    = logs[logs.length - 1];
            const pill    = last ? `<span class="call-pill ${last.status}">üìû ${last.service}</span>` : '';
            const ago     = this.timeAgo(a.timestamp);
            return `
            <div class="alert-card ${this.selectedId === a.alertId ? 'sel' : ''}" data-id="${a.alertId}" onclick="dc.select('${a.alertId}')">
                <div class="card-row">
                    <span style="font-size:13px;">${a.status === 'active' ? 'üö®' : '‚úÖ'}</span>
                    <span class="card-plate">${a.vehicleReg ?? '--'}</span>
                    <span class="card-desc">${a.vehicleColor ?? ''} ${a.vehicleMake ?? ''}</span>
                </div>
                <div class="card-driver">üë§ ${a.userName ?? ''} ${a.userSurname ?? ''}</div>
                ${a.userPhone ? `<div class="card-phone">üì± ${a.userPhone}</div>` : ''}
                <div class="card-loc">üìç ${a.location?.lat?.toFixed(4) ?? '--'}, ${a.location?.lng?.toFixed(4) ?? '--'}</div>
                <div class="card-meta">üïê ${ago}${a.battery ? `  üîã ${a.battery}%` : ''} ${pill}</div>
            </div>`;
        }).join('');
    },

    timeAgo(ts) {
        if (!ts) return '';
        const s = Math.floor((Date.now() - new Date(ts)) / 1000);
        if (s < 60) return s + 's ago';
        if (s < 3600) return Math.floor(s / 60) + 'm ago';
        return Math.floor(s / 3600) + 'h ago';
    },

    // ‚îÄ‚îÄ Select ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    select(id) {
        this.selectedId = id;
        this.render();
        this.renderDetails();
        this.updatePhoneDisplay();
        document.getElementById('emptyDet').style.display   = 'none';
        document.getElementById('detContent').style.display = 'flex';
    },

    // ‚îÄ‚îÄ Tab switch ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    switchTab(name, e) {
        document.querySelectorAll('.det-tab').forEach(t => t.classList.remove('on'));
        document.querySelectorAll('.tab-pane').forEach(p => p.classList.remove('on'));
        if (e?.target) e.target.classList.add('on');
        document.getElementById('tab-' + name).classList.add('on');
        if (name === 'retell') this.renderRetell();
    },

    // ‚îÄ‚îÄ Overview ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    renderDetails() {
        const a = this.allAlerts[this.selectedId];
        if (!a) return;

        document.getElementById('tab-overview').innerHTML = `
            <div style="display:flex;flex-direction:column;gap:9px;padding-top:4px;">
                ${a.status === 'active' ? `<div class="live-chip"><span></span> LIVE ‚Äî GPS updates in real time</div>` : ''}
                <div class="ov-card"><div class="ov-title">üë§ Driver</div><div class="ov-body">
                    <div><strong>Name:</strong> ${a.userName ?? ''} ${a.userSurname ?? ''}</div>
                    <div><strong>Phone:</strong> ${a.userPhone ?? '--'}</div>
                    <div><strong>User ID:</strong> ${a.userId ?? '--'}</div>
                </div></div>
                <div class="ov-card"><div class="ov-title">üöó Vehicle</div><div class="ov-body">
                    <div><strong>Plate:</strong>  ${a.vehicleReg   ?? '--'}</div>
                    <div><strong>Make:</strong>   ${a.vehicleMake  ?? '--'}</div>
                    <div><strong>Color:</strong>  ${a.vehicleColor ?? '--'}</div>
                </div></div>
                <div class="ov-card"><div class="ov-title">üìç Location</div><div class="ov-body">
                    <div><strong>Coordinates:</strong> <span id="det-live-loc">${a.location?.lat?.toFixed(6) ?? '--'}, ${a.location?.lng?.toFixed(6) ?? '--'} (¬±${a.location?.accuracy ?? '--'}m)</span></div>
                    <div><strong>Battery:</strong>   ${a.battery ?? '--'}%</div>
                    <div><strong>Triggered:</strong> ${a.timestamp ? new Date(a.timestamp).toLocaleString() : '--'}</div>
                    <div><strong>Last GPS:</strong>  ${a.lastSeen  ? new Date(a.lastSeen).toLocaleString()  : '--'}</div>
                    ${a.resolvedAt ? `<div><strong>Resolved:</strong> ${new Date(a.resolvedAt).toLocaleString()}</div>` : ''}
                    ${a.resolvedBy ? `<div><strong>By:</strong> ${a.resolvedBy}</div>` : ''}
                </div></div>
            </div>`;

        document.querySelectorAll('.det-tab').forEach(t => t.classList.remove('on'));
        document.querySelectorAll('.tab-pane').forEach(p => p.classList.remove('on'));
        document.querySelector('.det-tab').classList.add('on');
        document.getElementById('tab-overview').classList.add('on');
        this.renderNotes();
        this.renderRetell();
        document.getElementById('resolveBtn').style.display = a.status === 'active' ? 'flex' : 'none';
    },

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    //  RETELL / MAKE.COM PANEL
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    renderRetell() {
        const a = this.allAlerts[this.selectedId];
        if (!a) return;

        const hasWebhook = !!this.cfg.webhookUrl;
        const isActive   = a.status === 'active';
        const logs       = this.callLogs[this.selectedId] || [];

        const services = [
            { id:'saps',   icon:'üöî', name:'SAPS',           num: this.cfg.sapsNum   },
            { id:'armed',  icon:'üõ°Ô∏è', name:'Armed Response',  num: this.cfg.armedNum  },
            { id:'med',    icon:'üöë', name:'Medical',         num: this.cfg.medNum    },
            { id:'family', icon:'üë®‚Äçüë©‚Äçüëß', name:'Family',          num: this.cfg.familyNum },
        ];

        document.getElementById('servicesGrid').innerHTML = services.map(svc => {
            const last   = [...logs].reverse().find(l => l.service === svc.name);
            const status = last?.status ?? 'idle';
            const label  = {
                idle:     !svc.num ? '‚ö†Ô∏è No number set' : !hasWebhook ? '‚ö†Ô∏è No webhook' : 'Tap to call',
                calling:  'üìû Calling‚Ä¶',
                answered: '‚úÖ Connected',
                failed:   '‚ùå Failed',
                done:     '‚úì Done'
            }[status] ?? 'Tap to call';
            const disabled = (!hasWebhook || !svc.num || !isActive) ? 'disabled' : '';
            return `
            <button class="svc-btn ${status}" ${disabled} onclick="dc.triggerCall('${svc.name}','${svc.num}')">
                <div class="svc-icon">${svc.icon}</div>
                <div class="svc-name">${svc.name}</div>
                <div class="svc-num">${svc.num || '‚Äî'}</div>
                <div class="svc-status">${label}</div>
            </button>`;
        }).join('');

        // Auto toggle state
        const tog = document.getElementById('autoCallToggle');
        if (tog) tog.className = 'toggle' + (this.cfg.autoCall ? ' on' : '');

        // Webhook status
        const ws = document.getElementById('whStatus');
        if (!hasWebhook) {
            ws.style.display   = 'flex';
            ws.className       = 'wh-status err';
            ws.textContent     = '‚ö†Ô∏è No Make.com webhook ‚Äî go to Settings';
        } else if (!isActive) {
            ws.style.display   = 'flex';
            ws.className       = 'wh-status warn';
            ws.textContent     = '‚úÖ Alert resolved ‚Äî call buttons disabled';
        } else {
            ws.style.display   = 'none';
        }

        this.renderCallLog();
    },

    renderCallLog() {
        const el   = document.getElementById('callLog');
        if (!el) return;
        const logs = this.callLogs[this.selectedId] || [];
        if (!logs.length) { el.innerHTML = '<div style="font-size:10px;color:#334155;">No calls yet for this alert</div>'; return; }
        el.innerHTML = [...logs].reverse().map(l => `
            <div class="call-log-entry">
                <div class="call-log-ts">${new Date(l.ts).toLocaleTimeString()} ‚Äî ${l.dispatcher}</div>
                <div>${l.icon} <strong>${l.service}</strong> ${l.num}
                    ‚Äî <span style="color:${l.status==='answered'?'#86efac':l.status==='failed'?'#fca5a5':'#c084fc'}">${l.statusLabel}</span>
                </div>
                ${l.callId ? `<div style="color:#334155;font-size:9px;">Call ID: ${l.callId}</div>` : ''}
            </div>`).join('');
    },

    // ‚îÄ‚îÄ TRIGGER CALL via Make.com ‚Üí Retell ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    async triggerCall(serviceName, phoneNum, alertOverride) {
        const a = alertOverride ?? this.allAlerts[this.selectedId];
        if (!a)             { this.toast('‚ö†Ô∏è No alert selected', 'error'); return; }
        if (!this.cfg.webhookUrl) { this.toast('‚ö†Ô∏è Add Make.com webhook in Settings', 'error'); return; }
        if (!phoneNum)      { this.toast(`‚ö†Ô∏è No number set for ${serviceName}`, 'error'); return; }

        const mapsLink = `https://www.google.com/maps?q=${a.location?.lat},${a.location?.lng}`;

        // ‚îÄ‚îÄ Payload sent to Make.com ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        // Make.com receives this, passes it to Retell's /v2/create-phone-call
        // The retellVars object maps 1-to-1 to your Retell agent's dynamic variables
        const payload = {
            // Full alert context
            alertId:      a.alertId,
            timestamp:    a.timestamp,
            // Driver
            userName:     a.userName,
            userSurname:  a.userSurname,
            userId:       a.userId,
            // Vehicle
            vehicleReg:   a.vehicleReg,
            vehicleMake:  a.vehicleMake,
            vehicleColor: a.vehicleColor,
            // Location
            latitude:     a.location?.lat,
            longitude:    a.location?.lng,
            accuracy:     a.location?.accuracy,
            mapsLink,
            battery:      a.battery,
            // Call target
            callTarget:       serviceName,
            phoneNumber:      phoneNum,
            dispatcherName:   this.dispatcherName,
            // ‚îÄ‚îÄ Retell dynamic variable block ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            // In Make.com HTTP module ‚Üí Body ‚Üí retellVars
            // Map each key to the matching {{variable}} in your Retell prompt
            retellVars: {
                driver_name:    `${a.userName} ${a.userSurname}`,
                vehicle_reg:    a.vehicleReg,
                vehicle_desc:   `${a.vehicleColor} ${a.vehicleMake}`,
                gps_coords:     `${a.location?.lat?.toFixed(5)}, ${a.location?.lng?.toFixed(5)}`,
                maps_link:      mapsLink,
                battery:        String(a.battery ?? '--'),
                service_name:   serviceName,
                dispatcher:     this.dispatcherName
            }
        };

        // Add optimistic log entry
        const icons = { SAPS:'üöî', 'Armed Response':'üõ°Ô∏è', Medical:'üöë', Family:'üë®‚Äçüë©‚Äçüëß' };
        const entry = {
            ts: new Date().toISOString(), service: serviceName, num: phoneNum,
            icon: icons[serviceName] ?? 'üìû', status: 'calling',
            statusLabel: 'Calling via Retell‚Ä¶', dispatcher: this.dispatcherName, callId: null
        };
        if (!this.callLogs[a.alertId]) this.callLogs[a.alertId] = [];
        this.callLogs[a.alertId].push(entry);
        this.totalCallsMade++;
        this.renderRetell();
        this.render();
        this.toast(`üìû Retell agent calling ${serviceName}‚Ä¶`, 'purple');
        document.getElementById('callCount').textContent  = this.totalCallsMade;
        document.getElementById('totalCalls').textContent = this.totalCallsMade;

        // Write to Firebase
        update(ref(db, `alerts/${a.alertId}/calls/${Date.now()}`), {
            service: serviceName, phone: phoneNum,
            dispatcher: this.dispatcherName, status: 'calling', ts: entry.ts
        }).catch(() => {});

        // Fire the Make.com webhook
        try {
            const res = await fetch(this.cfg.webhookUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            if (res.ok) {
                let callId = null;
                try { const j = await res.json(); callId = j?.call_id ?? j?.id ?? null; } catch(_) {}
                entry.status      = 'answered';
                entry.statusLabel = 'Call connected ‚úÖ';
                entry.callId      = callId;
                this.toast(`‚úÖ ${serviceName} connected via Retell`, 'success');
            } else {
                entry.status      = 'failed';
                entry.statusLabel = `HTTP ${res.status} ‚Äî check Make.com logs`;
                this.toast(`‚ùå Webhook error ${res.status}`, 'error');
            }
        } catch(err) {
            entry.status      = 'failed';
            entry.statusLabel = 'Network error ‚Äî check webhook URL';
            this.toast(`‚ùå Could not reach Make.com`, 'error');
        }

        this.renderRetell();
        this.render();
    },

    toggleAutoCall() {
        this.cfg.autoCall = !this.cfg.autoCall;
        document.getElementById('autoCallToggle').className = 'toggle' + (this.cfg.autoCall ? ' on' : '');
        this.saveConfig();
        this.toast(this.cfg.autoCall ? 'ü§ñ Auto-call ON' : 'ü§ñ Auto-call OFF', 'purple');
    },

    // ‚îÄ‚îÄ Settings modal ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    showSettings() {
        document.getElementById('settingsWebhook').value  = this.cfg.webhookUrl || '';
        document.getElementById('settingsSaps').value     = this.cfg.sapsNum    || '';
        document.getElementById('settingsArmed').value    = this.cfg.armedNum   || '';
        document.getElementById('settingsMed').value      = this.cfg.medNum     || '';
        document.getElementById('settingsFamily').value   = this.cfg.familyNum  || '';
        document.getElementById('settingsAutoToggle').className = 'toggle' + (this.cfg.autoCall ? ' on' : '');
        document.getElementById('settingsModal').classList.add('show');
    },
    hideSettings() { document.getElementById('settingsModal').classList.remove('show'); },
    saveSettings() {
        this.cfg.webhookUrl = document.getElementById('settingsWebhook').value.trim();
        this.cfg.sapsNum    = document.getElementById('settingsSaps').value.trim();
        this.cfg.armedNum   = document.getElementById('settingsArmed').value.trim();
        this.cfg.medNum     = document.getElementById('settingsMed').value.trim();
        this.cfg.familyNum  = document.getElementById('settingsFamily').value.trim();
        this.cfg.autoCall   = document.getElementById('settingsAutoToggle').classList.contains('on');
        this.saveConfig();
        this.hideSettings();
        this.toast('‚úÖ Settings saved', 'success');
        this.updatePhoneDisplay();
        if (this.selectedId) this.renderRetell();
    },

    // ‚îÄ‚îÄ Service numbers panel (right sidebar) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    updatePhoneDisplay() {
        const el = document.getElementById('phoneDisplayPanel');
        if (!el) return;
        const services = [
            { icon:'üöî', name:'SAPS',           num: this.cfg.sapsNum   },
            { icon:'üõ°Ô∏è', name:'Armed Response',  num: this.cfg.armedNum  },
            { icon:'üöë', name:'Medical',         num: this.cfg.medNum    },
            { icon:'üë®‚Äçüë©‚Äçüëß', name:'Family',          num: this.cfg.familyNum },
        ];
        el.innerHTML = services.map(s => {
            const hasNum    = !!s.num;
            const hasAlert  = !!this.selectedId && this.allAlerts[this.selectedId]?.status === 'active';
            const canCall   = hasNum && hasAlert && !!this.cfg.webhookUrl;
            return `
            <div class="phone-display-row">
                <div class="phone-display-icon">${s.icon}</div>
                <div class="phone-display-info">
                    <div class="phone-display-name">${s.name}</div>
                    <div class="phone-display-num ${hasNum ? '' : 'empty'}">${hasNum ? s.num : 'Not set'}</div>
                </div>
                ${hasNum ? `<button class="phone-display-call" ${canCall ? '' : 'disabled'}
                    onclick="dc.triggerCall('${s.name}','${s.num}')">üìû Call</button>` : ''}
            </div>`;
        }).join('');
    },

    // ‚îÄ‚îÄ Notes ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    saveNote() {
        const text = document.getElementById('noteInput').value.trim();
        if (!text) { this.toast('‚ùå Empty note', 'error'); return; }
        if (!this.notes[this.selectedId]) this.notes[this.selectedId] = [];
        this.notes[this.selectedId].push({ ts: new Date().toISOString(), text, by: this.dispatcherName });
        document.getElementById('noteInput').value = '';
        this.renderNotes();
        this.toast('‚úÖ Note saved', 'success');
    },
    renderNotes() {
        const el = document.getElementById('notesLog');
        if (!el) return;
        (this.notes[this.selectedId] || []).forEach(n => {
            el.innerHTML += `<div class="note-entry"><div class="note-ts">${new Date(n.ts).toLocaleTimeString()} ‚Äî ${n.by}</div><div class="note-txt">${n.text}</div></div>`;
        });
        el.innerHTML = (this.notes[this.selectedId] || []).map(n =>
            `<div class="note-entry"><div class="note-ts">${new Date(n.ts).toLocaleTimeString()} ‚Äî ${n.by}</div><div class="note-txt">${n.text}</div></div>`
        ).join('');
    },

    // ‚îÄ‚îÄ Actions ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    openMaps() {
        const a = this.allAlerts[this.selectedId];
        if (!a?.location?.lat) { this.toast('‚ùå No location', 'error'); return; }
        window.open(`https://www.google.com/maps?q=${a.location.lat},${a.location.lng}`, '_blank');
    },
    copyDetails() {
        const a = this.allAlerts[this.selectedId]; if (!a) return;
        const text = `SECURELINK EMERGENCY\nDriver: ${a.userName} ${a.userSurname}\nVehicle: ${a.vehicleReg} ‚Äî ${a.vehicleColor} ${a.vehicleMake}\nGPS: ${a.location?.lat?.toFixed(6)}, ${a.location?.lng?.toFixed(6)}\nMaps: https://www.google.com/maps?q=${a.location?.lat},${a.location?.lng}\nBattery: ${a.battery ?? '--'}%\nTime: ${new Date(a.timestamp).toLocaleString()}`;
        navigator.clipboard.writeText(text).then(() => this.toast('üìã Copied!', 'success')).catch(() => this.toast('‚ùå Copy failed', 'error'));
    },
    async resolveAlert() {
        const a = this.allAlerts[this.selectedId]; if (!a) return;
        try {
            await update(ref(db, 'alerts/' + a.alertId), { status: 'resolved', resolvedBy: this.dispatcherName, resolvedAt: new Date().toISOString() });
            this.selectedId = null;
            document.getElementById('emptyDet').style.display   = 'flex';
            document.getElementById('detContent').style.display = 'none';
            this.toast(`‚úÖ Resolved by ${this.dispatcherName}`, 'success');
        } catch(e) { this.toast('‚ùå Could not resolve', 'error'); }
    },

    // ‚îÄ‚îÄ Stats ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    updateStats() {
        const all      = Object.values(this.allAlerts);
        const active   = all.filter(a => a.status === 'active').length;
        const resolved = all.filter(a => a.status === 'resolved').length;
        const total    = all.length;
        document.getElementById('activeCount').textContent   = active;
        document.getElementById('resolvedCount').textContent = resolved;
        document.getElementById('totalInc').textContent      = total;
        document.getElementById('resRate').textContent       = total > 0 ? Math.round(resolved / total * 100) + '%' : '‚Äî';
        const times = all.filter(a => a.resolvedAt && a.timestamp).map(a => new Date(a.resolvedAt) - new Date(a.timestamp));
        if (times.length) {
            const avg = times.reduce((s,t) => s+t, 0) / times.length;
            const h = Math.floor(avg/3600000), m = Math.floor((avg%3600000)/60000), s = Math.floor((avg%60000)/1000);
            document.getElementById('avgTime').textContent = `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
        } else document.getElementById('avgTime').textContent = '‚Äî';
    },

    init() { this.loadConfig(); }
};

dc.init();
</script>
</body>
</html>
